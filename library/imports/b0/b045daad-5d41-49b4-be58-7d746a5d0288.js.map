{"version":3,"sources":["../../../../../../../assets/Script/libs/wafer2-client-sdk/lib/assets/Script/libs/wafer2-client-sdk/lib/request.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"../../../../../../../assets/Script/libs/wafer2-client-sdk/lib","sourcesContent":["import constants from \"./constants\" \nimport utils from './utils'\nimport Session from \"./session\"\nimport loginLib from './login'\n\nvar noop = function noop() {};\n\nvar buildAuthHeader = function buildAuthHeader(session) {\n    var header = {};\n\n    if (session) {\n        header[constants.WX_HEADER_SKEY] = session;\n    }\n\n    return header;\n};\n\n/***\n * @class\n * 表示请求过程中发生的异常\n */\nvar RequestError = (function () {\n    function RequestError(type, message) {\n        Error.call(this, message);\n        this.type = type;\n        this.message = message;\n    }\n\n    RequestError.prototype = new Error();\n    RequestError.prototype.constructor = RequestError;\n\n    return RequestError;\n})();\n\nfunction request(options) {\n    if (typeof options !== 'object') {\n        var message = '请求传参应为 object 类型，但实际传了 ' + (typeof options) + ' 类型';\n        throw new RequestError(constants.ERR_INVALID_PARAMS, message);\n    }\n\n    var requireLogin = options.login;\n    var success = options.success || noop;\n    var fail = options.fail || noop;\n    var complete = options.complete || noop;\n    var originHeader = options.header || {};\n\n    // 成功回调\n    var callSuccess = function () {\n        success.apply(null, arguments);\n        complete.apply(null, arguments);\n    };\n\n    // 失败回调\n    var callFail = function (error) {\n        fail.call(null, error);\n        complete.call(null, error);\n    };\n\n    // 是否已经进行过重试\n    var hasRetried = false;\n\n    if (requireLogin) {\n        doRequestWithLogin();\n    } else {\n        doRequest();\n    }\n\n    // 登录后再请求\n    function doRequestWithLogin() {\n        loginLib.login({ success: doRequest, fail: callFail });\n    }\n\n    // 实际进行请求的方法\n    function doRequest() {\n        var authHeader = buildAuthHeader(Session.get());\n\n        wx.request(utils.extend({}, options, {\n            header: utils.extend({}, originHeader, authHeader),\n\n            success: function (response) {\n                var data = response.data;\n\n                var error, message;\n                if (data && data.code === -1) {\n                    Session.clear();\n                    // 如果是登录态无效，并且还没重试过，会尝试登录后刷新凭据重新请求\n                    if (!hasRetried) {\n                        hasRetried = true;\n                        doRequestWithLogin();\n                        return;\n                    }\n\n                    message = '登录态已过期';\n                    error = new RequestError(data.error, message);\n\n                    callFail(error);\n                    return;\n                } else {\n                    callSuccess.apply(null, arguments);\n                }\n            },\n\n            fail: callFail,\n            complete: noop,\n        }));\n    };\n\n};\n\nexport default {\n    RequestError: RequestError,\n    request: request,\n};"]}